
name: Build

on:
  workflow_call:
  push:
    tags:
      - '*'
    branches:
      - main

env:
  SERVER_PKG: cosmos_server
  CLIENT_PKG: cosmos_client

jobs:
  build-package:
    name: Build & Package (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            exe_suffix: ""
            shell: bash
            steam_lib: "libsteam_api.so"
            needs_deps: true
            use_steam_linux_runtime: true
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            exe_suffix: ".exe"
            shell: pwsh
            steam_lib: "steam_api64.dll"
            needs_deps: false
            use_steam_linux_runtime: false
          - os: macos-latest
            target: x86_64-apple-darwin
            exe_suffix: ""
            shell: bash
            steam_lib: "libsteam_api.dylib"
            needs_deps: false
            use_steam_linux_runtime: false
          - os: macos-latest
            target: aarch64-apple-darwin
            exe_suffix: ""
            shell: bash
            steam_lib: "libsteam_api.dylib"
            needs_deps: false
            use_steam_linux_runtime: false

    # Only use this container for Linux builds - it makes sure everything is compatible w/ the typical steam runtime
    container: ${{ matrix.use_steam_linux_runtime && 'registry.gitlab.steamos.cloud/steamrt/sniper/sdk:latest' || '' }}
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: false

      - uses: dtolnay/rust-toolchain@nightly
        with:
          targets: ${{ matrix.target }}

      # Linux-only native libs (okay to skip elsewhere)
      - name: Install Linux deps
        if: ${{ matrix.needs_deps }}
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config libx11-dev libasound2-dev libudev-dev \
            libxcb-render0-dev libxcb-shape0-dev libxcb-xfixes0-dev \
            libwayland-dev

      - name: Build both binaries (release) (Unix)
        if: runner.os != 'Windows'
        run: |
          # These cannot be in the same build command, or it enables both "server" and "client" features in core, which borks everything
          cargo +nightly build --release -p ${{ env.CLIENT_PKG }} --features extra-build-checks --target ${{ matrix.target }}
          cargo +nightly build --release -p ${{ env.SERVER_PKG }} --features extra-build-checks --target ${{ matrix.target }}

      - name: Build both binaries (release) (Windows)
        if: runner.os == 'Windows'
        run: |
          # These cannot be in the same build command, or it enables both "server" and "client" features in core, which borks everything
          cargo +nightly build --release -p $env:SERVER_PKG --features extra-build-checks --target ${{ matrix.target }}
          cargo +nightly build --release -p $env:CLIENT_PKG --features extra-build-checks --target ${{ matrix.target }}
      
      # ---------- Package (non-Windows) ----------
      - name: Package (Unix)
        if: ${{ runner.os != 'Windows' }}
        run: |
          set -eu

          DIST="dist"
          OUTDIR="${DIST}/cosmos_release"
          mkdir -p "${OUTDIR}/cosmos_server" "${OUTDIR}/cosmos_client"

          # Find libsteam_api.so recursively under target/release/build/
          LIBSTEAM_PATH=$(find "target/${{ matrix.target }}/release/build/" -type f -name "${{ matrix.steam_lib }}" | head -n 1)

          # Copy server binary + data
          cp "target/${{ matrix.target }}/release/${{ env.SERVER_PKG }}${{ matrix.exe_suffix }}" "${OUTDIR}/cosmos_server/"
          cp -r "${{ env.SERVER_PKG }}/assets" "${OUTDIR}/cosmos_server/"
          cp -r "${{ env.SERVER_PKG }}/config" "${OUTDIR}/cosmos_server/"
          cp -r "${{ env.SERVER_PKG }}/default_blueprints" "${OUTDIR}/cosmos_server/"
          cp "scripts/sh/run_server.sh" "${OUTDIR}/cosmos_server/"
          cp "${LIBSTEAM_PATH}" "${OUTDIR}/cosmos_server/"

          # Copy client binary + data
          cp "target/${{ matrix.target }}/release/${{ env.CLIENT_PKG }}${{ matrix.exe_suffix }}" "${OUTDIR}/cosmos_client/"
          cp -r "${{ env.CLIENT_PKG }}/assets" "${OUTDIR}/cosmos_client/"
          cp "scripts/sh/run_client.sh" "${OUTDIR}/cosmos_client/"
          cp "${LIBSTEAM_PATH}" "${OUTDIR}/cosmos_client/"

          # Zip it
          ( cd "${OUTDIR}" && zip -r "../cosmos_release.zip" . > /dev/null )
        shell: bash

      # ---------- Package (Windows) ----------
      - name: Package (Windows)
        if: ${{ runner.os == 'Windows' }}
        run: |
          $ErrorActionPreference = 'Stop'

          $dist   = "dist"
          $outdir = Join-Path $dist "cosmos_release"
          New-Item $outdir -ItemType Directory -Force | Out-Null
          New-Item (Join-Path $outdir "cosmos_server") -ItemType Directory -Force | Out-Null
          New-Item (Join-Path $outdir "cosmos_client") -ItemType Directory -Force | Out-Null

          # Find libsteam_api.so recursively under target/release/build/
          $libsteam_path = Get-ChildItem -Recurse -Path "target/${{ matrix.target }}/release/build" -Filter "${{ matrix.steam_lib }}" -File | Select-Object -First 1

          # Copy server
          Copy-Item "target/${{ matrix.target }}/release/${{ env.SERVER_PKG }}${{ matrix.exe_suffix }}" (Join-Path $outdir "cosmos_server/") -Force
          Copy-Item "${{ env.SERVER_PKG }}/assets" (Join-Path $outdir "cosmos_server/") -Recurse -Force
          Copy-Item "${{ env.SERVER_PKG }}/config" (Join-Path $outdir "cosmos_server/") -Recurse -Force
          Copy-Item "${{ env.SERVER_PKG }}/default_blueprints" (Join-Path $outdir "cosmos_server/") -Recurse -Force
          Copy-Item "scripts/bat/run_server.bat" (Join-Path $outdir "cosmos_server/") -Recurse -Force
          Copy-Item $libsteam_path.FullName -Destination (Join-Path $outdir "cosmos_server/") -Force

          # Copy client
          Copy-Item "target/${{ matrix.target }}/release/${{ env.CLIENT_PKG }}${{ matrix.exe_suffix }}" (Join-Path $outdir "cosmos_client/") -Force
          Copy-Item "${{ env.CLIENT_PKG }}/assets" (Join-Path $outdir "cosmos_client/") -Recurse -Force
          Copy-Item "scripts/bat/run_client.bat" (Join-Path $outdir "cosmos_client/") -Recurse -Force
          Copy-Item $libsteam_path.FullName -Destination (Join-Path $outdir "cosmos_client/") -Force

          # Zip it
          $zipPath = Join-Path $dist "cosmos_release.zip"
          if (Test-Path $zipPath) { Remove-Item $zipPath -Force }
          Compress-Archive -Path (Join-Path $outdir '*') -DestinationPath $zipPath -Force
        shell: pwsh

      - name: Upload artifact (zip)
        uses: actions/upload-artifact@v4
        with:
          name: cosmos-${{ matrix.target }}
          path: dist/cosmos_release.zip
          retention-days: 30

