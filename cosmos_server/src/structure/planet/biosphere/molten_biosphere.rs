//! Creates a molten planet

use bevy::{
    log::warn,
    prelude::{App, Component, Entity, Event, IntoSystemConfigs, OnEnter, Res, ResMut},
    reflect::TypePath,
};
use cosmos_core::{
    registry::Registry,
    structure::{
        coordinates::ChunkCoordinate,
        planet::generation::biome::{Biome, BiomeParameters, BiosphereBiomesRegistry},
    },
};

use crate::GameState;

use super::{BiosphereMarkerComponent, RegisterBiomesSet, TGenerateChunkEvent, TemperatureRange, register_biosphere};

#[derive(Component, Debug, Default, Clone, Copy, TypePath)]
/// Marks that this is for a grass biosphere
pub struct MoltenBiosphereMarker;

impl BiosphereMarkerComponent for MoltenBiosphereMarker {
    fn unlocalized_name() -> &'static str {
        "cosmos:molten"
    }
}

/// Marks that a grass chunk needs generated
#[derive(Debug, Event)]
pub struct MoltenChunkNeedsGeneratedEvent {
    coords: ChunkCoordinate,
    structure_entity: Entity,
}

impl TGenerateChunkEvent for MoltenChunkNeedsGeneratedEvent {
    fn new(coords: ChunkCoordinate, structure_entity: Entity) -> Self {
        Self { coords, structure_entity }
    }

    fn get_structure_entity(&self) -> Entity {
        self.structure_entity
    }

    fn get_chunk_coordinates(&self) -> ChunkCoordinate {
        self.coords
    }
}

fn register_biosphere_biomes(
    biome_registry: Res<Registry<Biome>>,
    mut biosphere_biomes_registry: ResMut<Registry<BiosphereBiomesRegistry>>,
) {
    let biosphere_registry = biosphere_biomes_registry
        .from_id_mut(MoltenBiosphereMarker::unlocalized_name())
        .expect("Missing molten biosphere registry!");

    if let Some(molten_biome) = biome_registry.from_id("cosmos:molten") {
        biosphere_registry.register(
            molten_biome,
            BiomeParameters {
                ideal_elevation: 30.0,
                ideal_humidity: 30.0,
                ideal_temperature: 60.0,
            },
        );
    } else {
        warn!("Missing molten biome!");
    }
}

pub(super) fn register(app: &mut App) {
    register_biosphere::<MoltenBiosphereMarker, MoltenChunkNeedsGeneratedEvent>(
        app,
        TemperatureRange::new(450.0, f32::MAX),
        0.75,
        Some("cosmos:lava"),
    );

    app.add_systems(
        OnEnter(GameState::PostLoading),
        register_biosphere_biomes
            .in_set(RegisterBiomesSet::RegisterBiomes)
            .ambiguous_with(RegisterBiomesSet::RegisterBiomes),
    );
}
